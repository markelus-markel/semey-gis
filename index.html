<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alau AI: –ì–ò–° –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ñ–ö–• –°–µ–º–µ–π</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        body { margin: 0; font-family: 'Inter', sans-serif; background: #0f172a; color: #f8fafc; overflow: hidden; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        
        .glass { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        
        .custom-popup .leaflet-popup-content-wrapper {
            background: #ffffff;
            color: #1e293b;
            border-radius: 12px;
            padding: 4px;
        }
        
        .active-district { 
            background: #3b82f6 !important; 
            color: white !important;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
        }

        /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ Leaflet */
        .leaflet-control-zoom { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div class="fixed top-4 left-4 right-4 z-[1000] flex flex-col gap-3 pointer-events-none">
        <div class="glass p-4 rounded-2xl shadow-2xl flex justify-between items-center pointer-events-auto">
            <div>
                <h1 class="font-bold text-lg leading-none tracking-tight">ALAU AI <span class="text-blue-400">–°–ï–ú–ï–ô</span></h1>
                <p id="stats-summary" class="text-[10px] text-slate-400 mt-1 uppercase tracking-widest font-semibold">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</p>
            </div>
            <div class="flex gap-2">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞..." 
                    class="bg-slate-800/50 border border-slate-700 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-32 md:w-64 transition-all">
            </div>
        </div>

        <div class="flex gap-2 overflow-x-auto pb-2 pointer-events-auto no-scrollbar">
            <button onclick="zoomTo('all', this)" class="district-btn active-district px-5 py-2 glass rounded-xl text-xs font-bold whitespace-nowrap uppercase tracking-wider">–í–µ—Å—å –≥–æ—Ä–æ–¥</button>
            <button onclick="zoomTo('center', this)" class="district-btn px-5 py-2 glass rounded-xl text-xs font-bold whitespace-nowrap uppercase tracking-wider">–¶–µ–Ω—Ç—Ä</button>
            <button onclick="zoomTo('batys', this)" class="district-btn px-5 py-2 glass rounded-xl text-xs font-bold whitespace-nowrap uppercase tracking-wider">–ë–∞—Ç—ã—Å</button>
            <button onclick="zoomTo('shygys', this)" class="district-btn px-5 py-2 glass rounded-xl text-xs font-bold whitespace-nowrap uppercase tracking-wider">–®—ã–≥—ã—Å</button>
            <button onclick="zoomTo('cem', this)" class="district-btn px-5 py-2 glass rounded-xl text-xs font-bold whitespace-nowrap uppercase tracking-wider">–¶–µ–º–ø–æ—Å–µ–ª–æ–∫</button>
        </div>
    </div>

    <div class="fixed right-4 top-44 z-[1000] flex flex-col gap-2">
        <div class="glass p-2 rounded-2xl shadow-xl flex flex-col gap-2 pointer-events-auto">
            <button onclick="filterOSI(false)" id="filter-all" class="p-3 rounded-xl bg-blue-600 text-white shadow-lg" title="–í—Å–µ –¥–æ–º–∞">üè†</button>
            <button onclick="filterOSI(true)" id="filter-osi" class="p-3 rounded-xl bg-slate-800 text-slate-400 hover:bg-slate-700" title="–¢–æ–ª—å–∫–æ –û–°–ò">‚úÖ</button>
        </div>
    </div>

    <div id="map"></div>

    <script>
        let map, markersLayer;
        let masterData = [];
        
        const sectorCoords = {
            all: { pos: [50.41, 80.25], zoom: 12 },
            center: { pos: [50.415, 80.246], zoom: 15 },
            batys: { pos: [50.405, 80.210], zoom: 14 },
            shygys: { pos: [50.425, 80.285], zoom: 14 },
            cem: { pos: [50.402, 80.218], zoom: 15 }
        };

        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        function initMap() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView(sectorCoords.all.pos, sectorCoords.all.zoom);
            
            // –¢–µ–º–Ω–∞—è –ø–æ–¥–ª–æ–∂–∫–∞
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            
            markersLayer = L.layerGroup().addTo(map);
            
            loadJSONData();

            // –ü–æ–∏—Å–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            document.getElementById('searchInput').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = masterData.filter(d => d.address.toLowerCase().includes(term));
                renderMarkers(filtered);
            });
        }

        // 2. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function loadJSONData() {
            try {
                const response = await fetch('buildings_fixed_locations.json');
                const data = await response.json();
                
                // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –º—É—Å–æ—Ä–∞ –∏ NaN
                masterData = data.filter(d => 
                    d.latitude && d.longitude && 
                    d.latitude > 50 && d.latitude < 51 && 
                    d.longitude > 80 && d.longitude < 81
                );

                renderMarkers(masterData);
                updateDashboard(masterData);
            } catch (err) {
                document.getElementById('stats-summary').innerText = "–û–®–ò–ë–ö–ê JSON";
                console.error(err);
            }
        }

        // 3. –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ—á–µ–∫ —Å –ò–ù–§–û-–û–ö–ù–û–ú
        function renderMarkers(data) {
            markersLayer.clearLayers();
            data.forEach(d => {
                const isOSI = d.management_type === '–û–°–ò';
                const color = isOSI ? '#10b981' : '#3b82f6'; // –ó–µ–ª–µ–Ω—ã–π –¥–ª—è –û–°–ò, —Å–∏–Ω–∏–π –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
                
                const marker = L.circleMarker([d.latitude, d.longitude], {
                    radius: 7,
                    fillColor: color,
                    color: '#ffffff',
                    weight: 1.5,
                    fillOpacity: 0.9
                });

                // –¢–û –°–ê–ú–û–ï –ò–ù–§–û-–û–ö–ù–û
                const popupHTML = `
                    <div class="p-2 min-w-[220px]">
                        <h3 class="font-bold text-slate-800 text-sm mb-2 border-b pb-1">${d.address}</h3>
                        <div class="grid grid-cols-2 gap-1 text-[11px] text-slate-600">
                            <span>–ì–æ–¥:</span> <span class="text-right font-bold text-slate-800">${d.year || '‚Äî'}</span>
                            <span>–ú–∞—Ç–µ—Ä–∏–∞–ª:</span> <span class="text-right font-bold text-slate-800">${d.material || '‚Äî'}</span>
                            <span>–≠—Ç–∞–∂–Ω–æ—Å—Ç—å:</span> <span class="text-right font-bold text-slate-800">${d.floors || '‚Äî'}</span>
                            <span>–ö–≤–∞—Ä—Ç–∏—Ä:</span> <span class="text-right font-bold text-slate-800">${d.apartments || '‚Äî'}</span>
                            <span class="mt-1">–¢–∏–ø —É–ø—Ä:</span> 
                            <span class="mt-1 text-right font-bold ${isOSI ? 'text-green-600' : 'text-blue-600'}">${d.management_type}</span>
                        </div>
                        <div class="mt-3 pt-2 border-t border-slate-100">
                            <div class="text-[9px] uppercase text-slate-400 font-bold">–ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å / –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</div>
                            <div class="text-[11px] font-bold text-slate-700 leading-tight mt-1">${d.chairman || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                            <div class="text-[11px] text-blue-500 mt-1">${d.phone || ''}</div>
                        </div>
                    </div>
                `;

                marker.bindPopup(popupHTML, { className: 'custom-popup' });
                markersLayer.addLayer(marker);
            });
        }

        // 4. –§—É–Ω–∫—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function zoomTo(key, btn) {
            document.querySelectorAll('.district-btn').forEach(b => b.classList.remove('active-district'));
            btn.classList.add('active-district');
            map.flyTo(sectorCoords[key].pos, sectorCoords[key].zoom, { duration: 1.5 });
        }

        function filterOSI(onlyOSI) {
            const btnAll = document.getElementById('filter-all');
            const btnOsi = document.getElementById('filter-osi');
            
            if (onlyOSI) {
                const filtered = masterData.filter(d => d.management_type === '–û–°–ò');
                renderMarkers(filtered);
                btnOsi.className = 'p-3 rounded-xl bg-green-500 text-white shadow-lg';
                btnAll.className = 'p-3 rounded-xl bg-slate-800 text-slate-400';
            } else {
                renderMarkers(masterData);
                btnAll.className = 'p-3 rounded-xl bg-blue-600 text-white shadow-lg';
                btnOsi.className = 'p-3 rounded-xl bg-slate-800 text-slate-400';
            }
        }

        function updateDashboard(data) {
            const total = data.length;
            const osiCount = data.filter(d => d.management_type === '–û–°–ò').length;
            const percent = ((osiCount / total) * 100).toFixed(1);
            document.getElementById('stats-summary').innerHTML = 
                `–í—Å–µ–≥–æ: <span class="text-white">${total}</span> | –û–°–ò: <span class="text-green-400">${osiCount} (${percent}%)</span>`;
        }

        window.onload = initMap;
    </script>
</body>
</html>
