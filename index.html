<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ГИС Мониторинга ЖКХ г. Семей</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            --primary-bg: #0f172a;
            --secondary-bg: #1e293b;
            --accent-bg: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --border-color: #475569;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        .main-container {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* Компактный мобильный хедер */
        .header {
            background: linear-gradient(135deg, var(--secondary-bg) 0%, var(--accent-bg) 100%);
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            flex-shrink: 0;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
            min-width: 0;
        }
        
        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--info) 0%, #06b6d4 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            color: white;
            flex-shrink: 0;
        }
        
        .header-title h1 {
            font-size: 0.95rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .header-title p {
            display: none;
        }
        
        .menu-btn {
            width: 36px;
            height: 36px;
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .menu-icon {
            width: 20px;
            height: 20px;
            color: var(--text-primary);
        }
        
        /* Карта на весь экран */
        .map-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* Выдвижная боковая панель */
        .sidebar {
            position: fixed;
            top: 0;
            left: -100%;
            width: 85%;
            max-width: 320px;
            height: 100%;
            background: rgba(30, 41, 59, 0.98);
            backdrop-filter: blur(10px);
            padding: 1rem;
            overflow-y: auto;
            z-index: 2000;
            transition: left 0.3s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
        }
        
        .sidebar.open {
            left: 0;
        }
        
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .sidebar-title {
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .close-sidebar-btn {
            width: 32px;
            height: 32px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Оверлей для закрытия сайдбара */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            display: none;
        }
        
        .sidebar-overlay.visible {
            display: block;
        }
        
        .control-group {
            margin-bottom: 1.5rem;
        }
        
        .control-group h3 {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.75rem;
            border-radius: 8px;
            transition: background-color 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        .checkbox-item:active {
            background: rgba(51, 65, 85, 0.7);
        }
        
        .checkbox {
            min-width: 20px;
            min-height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .checkbox.checked {
            background: var(--info);
            border-color: var(--info);
        }
        
        .checkbox.checked::after {
            content: '';
            position: absolute;
            left: 4px;
            top: 1px;
            width: 6px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        
        .select {
            width: 100%;
            padding: 0.875rem;
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .legend {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 8px;
            padding: 0.875rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
        }
        
        .legend-color {
            min-width: 14px;
            min-height: 14px;
            border-radius: 50%;
        }
        
        .stats-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%);
            border-radius: 8px;
            padding: 0.875rem;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .stats-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        
        .stats-value {
            font-weight: 600;
        }
        
        /* Мобильная панель информации */
        .info-panel {
            position: fixed;
            bottom: -100%;
            left: 0;
            right: 0;
            max-height: 70vh;
            background: rgba(30, 41, 59, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 20px 20px 0 0;
            padding: 1rem;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
            z-index: 1500;
            transition: bottom 0.3s ease;
            overflow-y: auto;
        }
        
        .info-panel.visible {
            bottom: 0;
        }
        
        .info-handle {
            width: 40px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 0 auto 1rem;
        }
        
        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .info-title {
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .info-field {
            margin-bottom: 0.875rem;
            padding: 0.75rem;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 8px;
        }
        
        .info-label {
            color: var(--text-secondary);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }
        
        .info-value {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        
        .info-grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.75rem;
        }
        
        /* Плавающая кнопка поиска */
        .search-fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: var(--info);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            cursor: pointer;
            z-index: 1000;
            border: none;
        }
        
        .search-fab svg {
            width: 24px;
            height: 24px;
            color: white;
        }
        
        /* Модальное окно поиска */
        .search-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary-bg);
            z-index: 2500;
            display: none;
            flex-direction: column;
        }
        
        .search-modal.visible {
            display: flex;
        }
        
        .search-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .search-input {
            flex: 1;
            padding: 0.75rem;
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--info);
        }
        
        .search-input::placeholder {
            color: var(--text-muted);
        }
        
        .search-results {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .search-result-item {
            padding: 1rem;
            background: var(--secondary-bg);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            cursor: pointer;
        }
        
        .search-result-item:active {
            background: var(--accent-bg);
        }
        
        .search-result-address {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .search-result-district {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        /* Кастомные попапы для мобилок */
        .leaflet-popup-content-wrapper {
            background: var(--secondary-bg);
            color: var(--text-primary);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            padding: 0;
        }
        
        .leaflet-popup-content {
            margin: 0;
            min-width: 200px;
        }
        
        .leaflet-popup-tip {
            background: var(--secondary-bg);
        }
        
        .popup-content {
            padding: 0.875rem;
        }
        
        .popup-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }
        
        .popup-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }
        
        .popup-value {
            font-weight: 600;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--secondary-bg);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            text-align: center;
            z-index: 10000;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--info);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Увеличиваем размер маркеров на мобилках */
        .leaflet-marker-icon {
            transform: scale(1.2);
        }
        
        /* Улучшаем контролы Leaflet для мобилок */
        .leaflet-control-zoom {
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .leaflet-control-zoom a {
            width: 36px;
            height: 36px;
            line-height: 36px;
            font-size: 20px;
            background: var(--secondary-bg);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        
        .leaflet-control-zoom a:hover {
            background: var(--accent-bg);
        }
        
        /* Безопасная зона для iPhone */
        @supports (padding: env(safe-area-inset-bottom)) {
            .header {
                padding-top: calc(0.75rem + env(safe-area-inset-top));
            }
            
            .info-panel {
                padding-bottom: calc(1rem + env(safe-area-inset-bottom));
            }
            
            .search-fab {
                bottom: calc(20px + env(safe-area-inset-bottom));
            }
        }
        
        /* Горизонтальная ориентация */
        @media (orientation: landscape) and (max-height: 500px) {
            .header-title p {
                display: none;
            }
            
            .info-panel {
                max-height: 80vh;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Загрузка данных...</div>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="main-container">
        <header class="header">
            <div class="header-left">
                <div class="menu-btn" id="menuBtn">
                    <svg class="menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </div>
                <div class="logo">СМ</div>
                <div class="header-title">
                    <h1>ГИС ЖКХ Семей</h1>
                    <p>Мониторинг жилого фонда</p>
                </div>
            </div>
        </header>

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Настройки карты</div>
                <button class="close-sidebar-btn" id="closeSidebarBtn">&times;</button>
            </div>

            <div class="control-group">
                <h3>Слои карты</h3>
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <div class="checkbox checked" data-layer="districts"></div>
                        <span>Административные районы</span>
                    </label>
                    <label class="checkbox-item">
                        <div class="checkbox checked" data-layer="buildings"></div>
                        <span>Многоквартирные дома</span>
                    </label>
                    <label class="checkbox-item">
                        <div class="checkbox" data-layer="heatmap"></div>
                        <span>Тепловая карта ОСИ</span>
                    </label>
                </div>
            </div>

            <div class="control-group">
                <h3>Фильтр по управлению</h3>
                <select class="select" id="managementFilter">
                    <option value="all">Все типы управления</option>
                    <option value="КСК">КСК (старая форма)</option>
                    <option value="ПТ">ПТ (Простое товарищество)</option>
                    <option value="ОСИ">ОСИ (Объединение собственников)</option>
                    <option value="Без управления">Без управления</option>
                </select>
            </div>

            <div class="control-group">
                <h3>Легенда</h3>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ef4444;"></div>
                        <span>КСК (старая форма)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f59e0b;"></div>
                        <span>ПТ (Простое товарищество)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #10b981;"></div>
                        <span>ОСИ (Объединение собственников)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #6b7280;"></div>
                        <span>Без управления</span>
                    </div>
                </div>
            </div>

            <div class="control-group">
                <h3>Статистика</h3>
                <div class="stats-card">
                    <div class="stats-item">
                        <span>Всего домов:</span>
                        <span class="stats-value" id="totalBuildings">-</span>
                    </div>
                    <div class="stats-item">
                        <span>Отображается:</span>
                        <span class="stats-value" id="filteredBuildings">-</span>
                    </div>
                    <div class="stats-item">
                        <span>ОСИ:</span>
                        <span class="stats-value" style="color: var(--success);" id="osiBuildings">-</span>
                    </div>
                    <div class="stats-item">
                        <span>КСК:</span>
                        <span class="stats-value" style="color: var(--danger);" id="kskBuildings">-</span>
                    </div>
                    <div class="stats-item">
                        <span>Процент ОСИ:</span>
                        <span class="stats-value" style="color: var(--info);" id="osiPercentage">-</span>
                    </div>
                </div>
            </div>
        </aside>

        <div class="map-container">
            <div id="map"></div>
            
            <button class="search-fab" id="searchFab">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </button>
            
            <div class="info-panel" id="infoPanel">
                <div class="info-handle"></div>
                <div class="info-header">
                    <div class="info-title">Информация о доме</div>
                    <button class="close-btn" onclick="closeInfoPanel()">&times;</button>
                </div>
                <div id="infoPanelContent"></div>
            </div>
        </div>
    </div>

    <div class="search-modal" id="searchModal">
        <div class="search-header">
            <button class="close-btn" id="closeSearchBtn">&times;</button>
            <input type="text" class="search-input" placeholder="Поиск по адресу или району..." id="searchInput" autocomplete="off">
        </div>
        <div class="search-results" id="searchResults"></div>
    </div>

    <script>
        // Глобальные переменные
        let map;
        let buildingsData = [];
        let districtsLayer;
        let buildingsLayer;
        let currentLayers = {
            districts: true,
            buildings: true,
            heatmap: false
        };
        let currentFilter = 'all';
        
        // Данные районов (упрощенные для мобилок)
        const districtsData = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "Polygon", 
                        "coordinates": [[
                            [80.2020, 50.4200], [80.2200, 50.4200], [80.2200, 50.4350], [80.2020, 50.4350], [80.2020, 50.4200]
                        ]]
                    },
                    "properties": {
                        "id": "batys", "name": "Жилой район Батыс", "population_2023": 92760
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [80.2200, 50.4250], [80.2450, 50.4250], [80.2450, 50.4400], [80.2200, 50.4400], [80.2200, 50.4250]
                        ]]
                    },
                    "properties": {
                        "id": "aksay", "name": "Жилой район Аксай", "population_2023": 13010
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [80.2250, 50.4050], [80.2550, 50.4050], [80.2550, 50.4250], [80.2250, 50.4250], [80.2250, 50.4050]
                        ]]
                    },
                    "properties": {
                        "id": "center", "name": "Общегородской центр", "population_2023": 65280
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [80.2620, 50.4050], [80.2850, 50.4050], [80.2850, 50.4270], [80.2620, 50.4270], [80.2620, 50.4050]
                        ]]
                    },
                    "properties": {
                        "id": "shygys", "name": "Жилой район Шыгыс", "population_2023": 19370
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [80.2100, 50.3920], [80.2300, 50.3920], [80.2300, 50.4080], [80.2100, 50.4080], [80.2100, 50.3920]
                        ]]
                    },
                    "properties": {
                        "id": "cemposelok", "name": "Жилой район Цемпоселок", "population_2023": 43570
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [80.1920, 50.4030], [80.2100, 50.4030], [80.2100, 50.4170], [80.1920, 50.4170], [80.1920, 50.4030]
                        ]]
                    },
                    "properties": {
                        "id": "ushaktar", "name": "Жилой район Ушактар", "population_2023": 17390
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [80.1820, 50.3820], [80.2050, 50.3820], [80.2050, 50.3980], [80.1820, 50.3980], [80.1820, 50.3820]
                        ]]
                    },
                    "properties": {
                        "id": "zhana_semey", "name": "Жилой район Жана Семей", "population_2023": 49930
                    }
                },
                {
                    "type": "Feature",
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [80.2420, 50.3720], [80.2650, 50.3720], [80.2650, 50.3880], [80.2420, 50.3880], [80.2420, 50.3720]
                        ]]
                    },
                    "properties": {
                        "id": "suyk_bulak", "name": "Жилой район Суык Булак", "population_2023": 6820
                    }
                }
            ]
        };
        
        const managementColors = {
            'КСК': '#ef4444',
            'ПТ': '#f59e0b', 
            'ОСИ': '#10b981',
            'Без управления': '#6b7280'
        };
        
        // Загрузка данных зданий
        function loadBuildingsData() {
            const residentialZones = {
                'Общегородской центр': [
                    {lat_min: 50.4120, lat_max: 50.4180, lon_min: 80.2350, lon_max: 80.2450},
                    {lat_min: 50.4080, lat_max: 50.4140, lon_min: 80.2400, lon_max: 80.2520},
                    {lat_min: 50.4160, lat_max: 50.4220, lon_min: 80.2280, lon_max: 80.2380}
                ],
                'Жилой район Цемпоселок': [
                    {lat_min: 50.3950, lat_max: 50.4020, lon_min: 80.2120, lon_max: 80.2200},
                    {lat_min: 50.3980, lat_max: 50.4050, lon_min: 80.2200, lon_max: 80.2280}
                ],
                'Жилой район Батыс': [
                    {lat_min: 50.4200, lat_max: 50.4280, lon_min: 80.2020, lon_max: 80.2120},
                    {lat_min: 50.4250, lat_max: 50.4320, lon_min: 80.2080, lon_max: 80.2180}
                ],
                'Жилой район Шыгыс': [
                    {lat_min: 50.4120, lat_max: 50.4180, lon_min: 80.2650, lon_max: 80.2750},
                    {lat_min: 50.4180, lat_max: 50.4240, lon_min: 80.2700, lon_max: 80.2800}
                ],
                'Жилой район Аксай': [
                    {lat_min: 50.4280, lat_max: 50.4340, lon_min: 80.2250, lon_max: 80.2350},
                    {lat_min: 50.4320, lat_max: 50.4380, lon_min: 80.2300, lon_max: 80.2400}
                ],
                'Жилой район Ушактар': [
                    {lat_min: 50.4050, lat_max: 50.4120, lon_min: 80.1950, lon_max: 80.2050},
                    {lat_min: 50.4080, lat_max: 50.4150, lon_min: 80.1980, lon_max: 80.2080}
                ],
                'Жилой район Жана Семей': [
                    {lat_min: 50.3850, lat_max: 50.3920, lon_min: 80.1850, lon_max: 80.1950},
                    {lat_min: 50.3880, lat_max: 50.3950, lon_min: 80.1920, lon_max: 80.2020}
                ],
                'Жилой район Суык Булак': [
                    {lat_min: 50.3750, lat_max: 50.3820, lon_min: 80.2450, lon_max: 80.2550},
                    {lat_min: 50.3780, lat_max: 50.3850, lon_min: 80.2500, lon_max: 80.2600}
                ]
            };
            
            const districtAddresses = {
                'Общегородской центр': ['ул. Абая', 'ул. Шакарима', 'ул. Гоголя', 'пр. Н. Назарбаева', 'ул. Ленина'],
                'Жилой район Цемпоселок': ['ул. Цементная', 'ул. Строительная', 'ул. Рабочая', 'ул. Индустриальная'],
                'Жилой район Батыс': ['ул. Западная', 'ул. Молодежная', 'ул. Новая', 'ул. Мира'],
                'Жилой район Шыгыс': ['ул. Восточная', 'ул. Солнечная', 'ул. Утренняя', 'ул. Рассветная'],
                'Жилой район Аксай': ['ул. Аксайская', 'ул. Береговая', 'ул. Речная', 'ул. Зеленая'],
                'Жилой район Ушактар': ['ул. Ушактарская', 'ул. Северная', 'ул. Лесная', 'ул. Парковая'],
                'Жилой район Жана Семей': ['ул. Жана Семей', 'ул. Новостройка', 'ул. Современная', 'ул. Перспективная'],
                'Жилой район Суык Булак': ['ул. Суык Булак', 'ул. Источная', 'ул. Родниковая', 'ул. Ключевая']
            };
            
            const targetCounts = {
                'Общегородской центр': 60,
                'Жилой район Цемпоселок': 40,
                'Жилой район Батыс': 30,
                'Жилой район Шыгыс': 25,
                'Жилой район Аксай': 15,
                'Жилой район Ушактар': 15,
                'Жилой район Жана Семей': 20,
                'Жилой район Суык Булак': 15
            };
            
            let buildingId = 1000;
            
            Object.entries(targetCounts).forEach(([district, count]) => {
                const zones = residentialZones[district] || residentialZones['Общегородской центр'];
                const streets = districtAddresses[district] || ['ул. Центральная'];
                
                for (let i = 0; i < count; i++) {
                    const zone = zones[Math.floor(Math.random() * zones.length)];
                    const lat = zone.lat_min + Math.random() * (zone.lat_max - zone.lat_min);
                    const lon = zone.lon_min + Math.random() * (zone.lon_max - zone.lon_min);
                    
                    let mgmtType;
                    const rand = Math.random();
                    
                    if (district === 'Жилой район Шыгыс' || district === 'Жилой район Батыс') {
                        if (rand < 0.30) mgmtType = 'ОСИ';
                        else if (rand < 0.40) mgmtType = 'ПТ';
                        else if (rand < 0.50) mgmtType = 'Без управления';
                        else mgmtType = 'КСК';
                    } else if (district === 'Жилой район Жана Семей' || district === 'Жилой район Суык Булак') {
                        if (rand < 0.25) mgmtType = 'ОСИ';
                        else if (rand < 0.40) mgmtType = 'ПТ';
                        else if (rand < 0.50) mgmtType = 'Без управления';
                        else mgmtType = 'КСК';
                    } else {
                        if (rand < 0.10) mgmtType = 'ОСИ';
                        else if (rand < 0.20) mgmtType = 'ПТ';
                        else if (rand < 0.30) mgmtType = 'Без управления';
                        else mgmtType = 'КСК';
                    }
                    
                    const building = {
                        id: `realistic_${buildingId}`,
                        address: `${streets[Math.floor(Math.random() * streets.length)]}, ${Math.floor(Math.random() * 150) + 1}`,
                        latitude: lat,
                        longitude: lon,
                        management_type: mgmtType,
                        district: district,
                        residents_count: Math.floor(Math.random() * 200) + 50,
                        year: Math.floor(Math.random() * 60) + 1960,
                        floors: Math.floor(Math.random() * 10) + 2,
                        apartments: Math.floor(Math.random() * 100) + 10,
                        total_area: Math.floor(Math.random() * 5000) + 500
                    };
                    
                    buildingsData.push(building);
                    buildingId++;
                }
            });
        }
        
        // Инициализация карты
        function initMap() {
            map = L.map('map', {
                zoomControl: true,
                attributionControl: false,
                tap: true,
                maxZoom: 18,
                minZoom: 11
            }).setView([50.4150, 80.2467], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
            }).addTo(map);
            
            // Загрузка данных
            loadBuildingsData();
            createDistrictsLayer();
            createBuildingsLayer();
            updateStatistics();
            
            // Скрытие загрузки
            document.getElementById('loading').style.display = 'none';
        }
        
        // Создание слоя районов
        function createDistrictsLayer() {
            districtsLayer = L.geoJSON(districtsData, {
                style: function(feature) {
                    const stats = getDistrictStats(feature.properties.name);
                    const opacity = currentLayers.heatmap ? 
                        Math.min(stats.osiPercentage / 100 * 2, 0.8) : 0.3;
                    
                    return {
                        color: '#374151',
                        weight: 2,
                        fillColor: currentLayers.heatmap ? '#3b82f6' : '#64748b',
                        fillOpacity: opacity
                    };
                },
                onEachFeature: function(feature, layer) {
                    const stats = getDistrictStats(feature.properties.name);
                    
                    const popupContent = `
                        <div class="popup-content">
                            <div class="popup-title">${feature.properties.name}</div>
                            <div class="popup-item">
                                <span>Население:</span>
                                <span class="popup-value">${feature.properties.population_2023.toLocaleString()}</span>
                            </div>
                            <div class="popup-item">
                                <span>Всего домов:</span>
                                <span class="popup-value">${stats.total}</span>
                            </div>
                            <div class="popup-item">
                                <span>ОСИ:</span>
                                <span class="popup-value" style="color: var(--success)">${stats.osi}</span>
                            </div>
                            <div class="popup-item">
                                <span>Процент ОСИ:</span>
                                <span class="popup-value" style="color: var(--info)">${stats.osiPercentage.toFixed(1)}%</span>
                            </div>
                        </div>
                    `;
                    
                    layer.bindPopup(popupContent);
                }
            });
            
            if (currentLayers.districts) {
                districtsLayer.addTo(map);
            }
        }
        
        // Создание слоя зданий
        function createBuildingsLayer() {
            buildingsLayer = L.layerGroup();
            updateBuildingsLayer();
            
            if (currentLayers.buildings) {
                buildingsLayer.addTo(map);
            }
        }
        
        // Обновление слоя зданий
        function updateBuildingsLayer() {
            buildingsLayer.clearLayers();
            
            const filteredBuildings = getFilteredBuildings();
            
            filteredBuildings.forEach(building => {
                const marker = L.circleMarker([building.latitude, building.longitude], {
                    radius: 8,
                    color: managementColors[building.management_type],
                    fillColor: managementColors[building.management_type],
                    fillOpacity: 0.8,
                    weight: 2
                });
                
                marker.on('click', function() {
                    showBuildingInfo(building);
                });
                
                buildingsLayer.addLayer(marker);
            });
        }
        
        // Получение отфильтрованных зданий
        function getFilteredBuildings() {
            return buildingsData.filter(building => {
                return currentFilter === 'all' || building.management_type === currentFilter;
            });
        }
        
        // Получение статистики района
        function getDistrictStats(districtName) {
            const districtBuildings = buildingsData.filter(b => b.district === districtName);
            const total = districtBuildings.length;
            const osi = districtBuildings.filter(b => b.management_type === 'ОСИ').length;
            
            return {
                total,
                osi,
                osiPercentage: total > 0 ? (osi / total) * 100 : 0
            };
        }
        
        // Обновление статистики
        function updateStatistics() {
            const filteredBuildings = getFilteredBuildings();
            const total = buildingsData.length;
            const filtered = filteredBuildings.length;
            const osi = buildingsData.filter(b => b.management_type === 'ОСИ').length;
            const ksk = buildingsData.filter(b => b.management_type === 'КСК').length;
            const osiPercentage = total > 0 ? (osi / total * 100).toFixed(1) : 0;
            
            document.getElementById('totalBuildings').textContent = total;
            document.getElementById('filteredBuildings').textContent = filtered;
            document.getElementById('osiBuildings').textContent = osi;
            document.getElementById('kskBuildings').textContent = ksk;
            document.getElementById('osiPercentage').textContent = osiPercentage + '%';
        }
        
        // Показ информации о здании
        function showBuildingInfo(building) {
            const panel = document.getElementById('infoPanel');
            const content = document.getElementById('infoPanelContent');
            
            content.innerHTML = `
                <div class="info-field">
                    <div class="info-label">Адрес</div>
                    <div class="info-value">${building.address}</div>
                </div>
                
                <div class="info-grid">
                    <div class="info-field">
                        <div class="info-label">Тип управления</div>
                        <div class="info-value" style="color: ${managementColors[building.management_type]}">${building.management_type}</div>
                    </div>
                    <div class="info-field">
                        <div class="info-label">Год постройки</div>
                        <div class="info-value">${building.year}</div>
                    </div>
                </div>
                
                <div class="info-grid-3">
                    <div class="info-field">
                        <div class="info-label">Этажей</div>
                        <div class="info-value">${building.floors}</div>
                    </div>
                    <div class="info-field">
                        <div class="info-label">Квартир</div>
                        <div class="info-value">${building.apartments}</div>
                    </div>
                    <div class="info-field">
                        <div class="info-label">Жителей</div>
                        <div class="info-value">${building.residents_count}</div>
                    </div>
                </div>
                
                <div class="info-field">
                    <div class="info-label">Район</div>
                    <div class="info-value">${building.district}</div>
                </div>
                
                <div class="info-field">
                    <div class="info-label">Общая площадь</div>
                    <div class="info-value">${building.total_area.toLocaleString()} м²</div>
                </div>
            `;
            
            panel.classList.add('visible');
            map.closePopup();
        }
        
        // Закрытие панели информации
        function closeInfoPanel() {
            document.getElementById('infoPanel').classList.remove('visible');
        }
        
        // Переключение слоев
        function toggleLayer(layerName) {
            currentLayers[layerName] = !currentLayers[layerName];
            
            switch(layerName) {
                case 'districts':
                    if (currentLayers.districts) {
                        map.addLayer(districtsLayer);
                    } else {
                        map.removeLayer(districtsLayer);
                    }
                    break;
                    
                case 'buildings':
                    if (currentLayers.buildings) {
                        map.addLayer(buildingsLayer);
                    } else {
                        map.removeLayer(buildingsLayer);
                    }
                    break;
                    
                case 'heatmap':
                    createDistrictsLayer();
                    break;
            }
        }
        
        // Поиск зданий
        function searchBuildings(query) {
            const results = buildingsData.filter(building => 
                building.address.toLowerCase().includes(query.toLowerCase()) ||
                building.district.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 20);
            
            const resultsContainer = document.getElementById('searchResults');
            
            if (results.length === 0) {
                resultsContainer.innerHTML = '<div style="padding: 1rem; color: var(--text-muted);">Ничего не найдено</div>';
                return;
            }
            
            resultsContainer.innerHTML = results.map(building => `
                <div class="search-result-item" onclick="selectBuilding('${building.id}')">
                    <div class="search-result-address">${building.address}</div>
                    <div class="search-result-district">${building.district}</div>
                </div>
            `).join('');
        }
        
        // Выбор здания из поиска
        function selectBuilding(buildingId) {
            const building = buildingsData.find(b => b.id === buildingId);
            if (building) {
                map.setView([building.latitude, building.longitude], 17);
                showBuildingInfo(building);
                document.getElementById('searchModal').classList.remove('visible');
            }
        }
        
        // Обработчики событий
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            
            // Кнопка меню
            document.getElementById('menuBtn').addEventListener('click', function() {
                document.getElementById('sidebar').classList.add('open');
                document.getElementById('sidebarOverlay').classList.add('visible');
            });
            
            // Закрытие сайдбара
            document.getElementById('closeSidebarBtn').addEventListener('click', function() {
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('sidebarOverlay').classList.remove('visible');
            });
            
            document.getElementById('sidebarOverlay').addEventListener('click', function() {
                document.getElementById('sidebar').classList.remove('open');
                this.classList.remove('visible');
            });
            
            // Чекбоксы слоев
            document.querySelectorAll('[data-layer]').forEach(checkbox => {
                checkbox.addEventListener('click', function(e) {
                    e.preventDefault();
                    this.classList.toggle('checked');
                    toggleLayer(this.dataset.layer);
                });
            });
            
            // Фильтр управления
            document.getElementById('managementFilter').addEventListener('change', function() {
                currentFilter = this.value;
                updateBuildingsLayer();
                updateStatistics();
            });
            
            // Кнопка поиска
            document.getElementById('searchFab').addEventListener('click', function() {
                document.getElementById('searchModal').classList.add('visible');
                document.getElementById('searchInput').focus();
            });
            
            // Закрытие поиска
            document.getElementById('closeSearchBtn').addEventListener('click', function() {
                document.getElementById('searchModal').classList.remove('visible');
                document.getElementById('searchInput').value = '';
                document.getElementById('searchResults').innerHTML = '';
            });
            
            // Поиск
            let searchTimeout;
            document.getElementById('searchInput').addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length < 2) {
                    document.getElementById('searchResults').innerHTML = '';
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    searchBuildings(query);
                }, 300);
            });
            
            // Закрытие панели инфо при клике вне её
            document.getElementById('map').addEventListener('click', function() {
                closeInfoPanel();
            });
        });
    </script>
</body>
</html>
